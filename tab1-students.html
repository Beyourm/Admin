<h2>๐ ูุงุฆูุฉ ุงูุทูุงุจ ุงููุณุฌููู</h2>

<div id="students-container" class="students-container">
  <div class="loader-placeholder">
    <div class="loader">ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช...</div>
  </div>
</div>

<script>
// ุชุญุฏูุฏ ุงูุฑุงุจุท API
const DATA_URL = 'https://script.google.com/macros/s/AKfycbxTAdC8g-J42sbnCfIxe2_Z286N5v7vKVhrL9iyJ_b3JzRMIpsClyPWqYV7usFjiIKmVQ/exec';

// ูุธููุฉ ุฃูุงู ูููุน ูุฌูุงุช XSS
function escapeHTML(str) {
  if (!str && str !== 0) return '-';
  return str.toString().replace(/[&<>"']/g, match => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[match]));
}

// ---------------- ูุธููุฉ ูุนุงูุฌุฉ ุชูุณูู ุงูุชุงุฑูุฎ ----------------
function formatGoogleSheetDate(dateString) {
    if (!dateString) return 'ุบูุฑ ูุชููุฑ';

    // 1. ูุนุงูุฌุฉ ุฑููุฒ ุงูููููููุฏ ุบูุฑ ุงูููุงุณูุฉ (ุงูุชู ุชุณุจุจ Invalid Date)
    // - ุงุณุชุจุฏุงู ุงูุฑููุฒ ุบูุฑ ุงููุฑุฆูุฉ (โ) ุจูุณุงูุฉ ูุงุฑุบุฉ
    // - ุงุณุชุจุฏุงู ุงูููุงุตู ุจูู ุงูุชุงุฑูุฎ ูุงูููุช ุจูุณุงูุฉ (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
    let cleanedDate = dateString
        .replace(/โ/g, '') // ุฅุฒุงูุฉ ุฑูุฒ RLM (Right-to-Left Mark)
        .replace(/ู/g, 'PM').replace(/ุต/g, 'AM') // ุชุญููู ู/ุต ุฅูู AM/PM
        .replace(/\//g, '-') // ุงุณุชุจุฏุงู / ุจู - ูุชุญุณูู ุงูุชูุงูู
        .replace(/\./g, ' '); // ุฅุฒุงูุฉ ุฃู ููุงุท ุบูุฑ ุถุฑูุฑูุฉ

    // ูุญุงููุฉ ุฅูุดุงุก ูุงุฆู Date
    const dateObj = new Date(cleanedDate);

    // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ุตุงูุญุงู
    if (isNaN(dateObj)) {
        // ุฅุฐุง ูุดู ุงูุชุญููู ุงูุชููุงุฆูุ ุญุงูู ูุนุงูุฌุฉ ุงูุชูุณูู ูุฏููุงู (Day/Month/Year)
        const parts = cleanedDate.match(/(\d+)[-/](\d+)[-/](\d+)\s(.*)/); // ูุญุงููุฉ ูุตู ุงูุชุงุฑูุฎ ูุงูููุช
        if (parts && parts.length === 5) {
            // ุชูุณูู Google Sheets ูู ุบุงูุจุงู Month/Day/Year ุฃู Day/Month/Year
            // ููุชุฑุถ Day/Month/Year ููููู ุจุชุฌููุนูุง
            const [_, day, month, year, time] = parts;
            const isoFormatted = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${time}`;
            const manualDateObj = new Date(isoFormatted);
             if (!isNaN(manualDateObj)) {
                 return manualDateObj.toLocaleDateString('ar-EG');
             }
        }
        return 'Invalid Date'; // ุฅุฐุง ูุดูุช ุฌููุน ุงููุญุงููุงุช
    }

    // ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ุตุงูุญุงูุ ูู ุจุชูุณููู
    return dateObj.toLocaleDateString('ar-EG');
}


async function loadStudentsData() {
  const container = document.getElementById('students-container');
  
  if (!container) {
      console.error('Students container element not found.');
      return; 
  }
  
  container.style.display = 'block';
  container.innerHTML = `<div class="loader-placeholder"><div class="loader">ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช...</div></div>`;

  try {
    const response = await fetch(DATA_URL);
    if (!response.ok) {
        throw new Error(`ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู. ุงูุญุงูุฉ: ${response.status}`);
    }

    const students = await response.json();

    if (!Array.isArray(students) || students.length === 0) {
      container.style.display = 'block';
      container.innerHTML = `<p style="text-align:center; color: var(--text-color-dark);">ูุง ุชูุฌุฏ ุจูุงูุงุช ุทูุงุจ ูุณุฌููู ูุนุฑุถูุง ุญุงููุงู.</p>`;
      return;
    }

    // ุฅูุดุงุก ุงูุจุทุงูุงุช
    const cardsHtml = students.map(s => {
      // ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ููุนุงูุฌุฉ ุงูุชุงุฑูุฎ
      const date = formatGoogleSheetDate(s['ุชุงุฑูุฎ ุงูุชุณุฌูู']); 
      
      // ุชูุณูู ุงุณู ุงูุฏูุฑุฉ ุงููุทููุจ
      const courseName = `ุฏูุฑุฉ :ู ${escapeHTML(s['ุงุณู ุงูุฏูุฑุฉ'])}`;

      const whatsappLink = s['ุฑูู ุงููุงุชุณุงุจ']
        ? `<a href="https://wa.me/${s['ุฑูู ุงููุงุชุณุงุจ'].toString().replace(/\s/g, '').replace('+', '')}" target="_blank" style="color: var(--primary-color); text-decoration: none;">${escapeHTML(s['ุฑูู ุงููุงุชุณุงุจ'])}</a>`
        : escapeHTML(s['ุฑูู ุงููุงุชุณุงุจ']);

      return `
        <div class="student-card">
          <div class="course">${courseName}</div> <h3>${escapeHTML(s['ุงูุงุณู'])}</h3>
          <div class="info">
            <div><span class="label">ุงูุจูุฏ:</span> ${escapeHTML(s['ุงูุจูุฏ'])}</div>
            <div><span class="label">ุงูุนูุฑ:</span> ${escapeHTML(s['ุงูุนูุฑ'])}</div>
            <div><span class="label">ุงููุงุชุณุงุจ:</span> ${whatsappLink}</div>
            <div><span class="label">ุชุงุฑูุฎ ุงูุชุณุฌูู:</span> ${date}</div> <div><span class="label">ุงููุณููู:</span> ${escapeHTML(s['ูุนุฑูู ุงููุณููู'])}</div>
          </div>
        </div>
      `;
    }).join('');

    // ุชุญุฏูุซ ุงููุญุชูู ูุชูุนูู ุนุฑุถ ุงูู Grid
    container.style.display = 'grid'; 
    container.innerHTML = cardsHtml;

  } catch (err) {
    console.error('Error fetching student data:', err);
    container.style.display = 'block';
    container.innerHTML = `<p style="text-align:center; color: var(--error-color); background: var(--error-light); padding: 10px; border-radius: 8px;">
        ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ุงูุจูุงูุงุช: ${err.message}.
    </p>`;
  }
}

// ---------------- ุงูุชูููุฐ ุงูููุฑู ูุงูููุซูู ----------------
setTimeout(loadStudentsData, 0); 

</script>
